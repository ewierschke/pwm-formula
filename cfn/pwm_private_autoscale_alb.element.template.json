{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Conditions": {
    "ConfigureDiscovery": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "DiscoIAMGroup"
            },
            ""
          ]
        }
      ]
    }
  },
  "Description": "This template deploys a pwm instance from launch config in an autoscale group behind an ALB using watchmaker.",
  "Parameters": {
    "ADHostname": {
      "AllowedPattern": "[a-zA-Z0-9]+\\..+",
      "Default": "ad.example.com",
      "Description": "Hostname (FQDN) of the AD server to query for users to notify of password expirations",
      "MaxLength": "25",
      "MinLength": "3",
      "Type": "String"
    },
    "AdminIAMGroup": {
      "Description": "ID of the IAM group to be granted SSH Admin access to pwm instances",
      "Type": "String"
    },
    "AdminReportMailToEmailAddress": {
      "AllowedPattern": "^([a-zA-Z0-9_\\-\\.]+)@([a-zA-Z0-9_\\-\\.]+)\\.([a-zA-Z]{2,5})$",
      "Default": "admin@example.com",
      "Description": "Email address to which to send Admin report of password expirations",
      "MinLength": "3",
      "MaxLength": "50",
      "Type": "String"
    },
    "ADOUPath": {
      "Default": "CN=Users,DC=ad,DC=example,DC=com",
      "Description": "Distinguished Name (DN) of the OU path containing users to which to send password expiration notices",
      "MinLength": "1",
      "Type": "String"
    },
    "ADSvcAccountPassword": {
      "AllowedPattern": "(?=^.{6,255}$)((?=.*\\d)(?=.*[A-Z])(?=.*[a-z])|(?=.*\\d)(?=.*[^A-Za-z0-9])(?=.*[a-z])|(?=.*[^A-Za-z0-9])(?=.*[A-Z])(?=.*[a-z])|(?=.*\\d)(?=.*[A-Z])(?=.*[^A-Za-z0-9]))^.*",
      "Default": "Password123",
      "Description": "Password of the Service Account used to query LDAP directory. Must be at least 8 characters containing letters, numbers and symbols",
      "MaxLength": "32",
      "MinLength": "8",
      "NoEcho": "true",
      "Type": "String"
    },
    "ADSvcAccountUPN": {
      "Default": "svc_account@example.com",
      "Description": "UPN of the service account used to query LDAP directory.",
      "Type": "String"
    },
    "AmiId": {
      "Description": "AMI ID",
      "Type": "String"
    },
    "ConfigureADPasswordExpireNotify": {
      "AllowedValues": [
        "no",
        "yes"
      ],
      "Default": "yes",
      "Description": "Select yes to execute state that configures AD password expiration notification emails",
      "Type": "String"
    },
    "ConfigureOstNewUserNotificationviaAPI": {
      "AllowedValues": [
        "no",
        "yes"
      ],
      "Default": "yes",
      "Description": "Select yes to execute state that configures AD password expiration notification emails",
      "Type": "String"
    },
    "ConfigureOstNewUserNotificationviaEmail": {
      "AllowedValues": [
        "no",
        "yes"
      ],
      "Default": "no",
      "Description": "Select yes to execute state that configures AD password expiration notification emails",
      "Type": "String"
    },
    "DesiredCapacity": {
      "Default": "1",
      "Description": "The number of instances the autoscale group will spin up initially",
      "MinLength": "1",
      "Type": "String"
    },
    "DiscoIAMGroup": {
      "Default": "",
      "Description": "ID of the IAM group to be granted SSH Discovery access to pwm instances",
      "Type": "String"
    },
    "FriendlyEnvironmentName": {
      "Default": "Example",
      "Description": "Friendly name of the Environment in which pwm is being installed, for use in emails and branding (future use)",
      "MaxLength": "25",
      "MinLength": "3",
      "Type": "String"
    },
    "HelpdeskAPIKey": {
      "Default": "THISISAFAKEAPIKEY",
      "Description": "When ConfigureOstNewUserNotificationviaAPI is configured to yes, this API Key is used to submit new user tickets",
      "NoEcho": "true",
      "Type": "String"
    },
    "HelpdeskEmailAddress": {
      "AllowedPattern": "^([a-zA-Z0-9_\\-\\.]+)@([a-zA-Z0-9_\\-\\.]+)\\.([a-zA-Z]{2,5})$",
      "Default": "help@example.com",
      "Description": "Email address used by helpdesk system to be included in notification emails",
      "MaxLength": "50",
      "MinLength": "3",
      "Type": "String"
    },
    "HelpdeskPublicURL": {
      "Description": "Public URL of helpdesk system to be included in notification emails",
      "Type": "String"
    },
    "InstanceType": {
      "AllowedValues": [
        "t2.micro",
        "t2.small",
        "t2.medium",
        "t2.large",
        "t2.xlarge",
        "c4.large",
        "c4.xlarge",
        "m4.large",
        "m4.xlarge"
      ],
      "Default": "t2.micro",
      "Description": "Amazon EC2 instance type for the pwm Instance (using Aug16 ACB CentOS6 AMI)",
      "Type": "String"
    },
    "KeyPairName": {
      "Description": "Public/private key pairs allow you to securely connect to your instance after it launches",
      "Type": "AWS::EC2::KeyPair::KeyName"
    },
    "MailFromDNSDomainName": {
      "AllowedPattern": "[a-zA-Z0-9]+\\..+",
      "Default": "example.com",
      "Description": "Fully qualified domain name (FQDN) of the domain e.g. example.com, from which email will originate, usually the same as ResourceDNSDomainName (future use)",
      "MaxLength": "25",
      "MinLength": "3",
      "Type": "String"
    },
    "MailFromEmailAddress": {
      "Default": "noreply@example.com",
      "Description": "Email address provided in the from field in notification emails",
      "MaxLength": "50",
      "MinLength": "3",
      "Type": "String"
    },
    "MailFrompwmEmailAddress": {
      "Default": "pwm@example.com",
      "Description": "Email address used in API submissions to the helpdesk system via API",
      "MaxLength": "50",
      "MinLength": "3",
      "Type": "String"
    },
    "MaxCapacity": {
      "Default": "1",
      "Description": "The maximum number of instances for the autoscale group",
      "MinLength": "1",
      "Type": "String"
    },
    "MinCapacity": {
      "Default": "1",
      "Description": "The minimum number of instances for the autoscale group",
      "MinLength": "1",
      "Type": "String"
    },
    "NewUserMailToEmailAddress": {
      "AllowedPattern": "^([a-zA-Z0-9_\\-\\.]+)@([a-zA-Z0-9_\\-\\.]+)\\.([a-zA-Z]{2,5})$",
      "Default": "help@example.com",
      "Description": "Email address to send new user created notification emails",
      "MinLength": "3",
      "Type": "String"
    },
    "PrivateSubnetIDs": {
      "Description": "Private Subnet ID where the pwm instance(s) will run. (only select one, load balancing not tested)",
      "Type": "List<AWS::EC2::Subnet::Id>"
    },
    "pwmALBTargetGroupName": {
      "Description": "Name of the ALB pwm Target Group",
      "Type": "String",
      "MinLength": "1"
    },
    "pwmConfigBucketName": {
      "Description": "Name of the S3 bucket where the pwm config should be pulled and stored",
      "Type": "String"
    },
    "pwmPublicURL": {
      "Description": "Public URL to this pwm instance to be included in notification emails",
      "Type": "String"
    },
    "pwmSNSTopicARN": {
      "Description": "ARN of the SNS Topic to which to send auto scale action notifications",
      "Type": "String"
    },
    "ResourceDNSDomainName": {
      "AllowedPattern": "[a-zA-Z0-9]+\\..+",
      "Default": "example.com",
      "Description": "Fully qualified domain name (FQDN) of the domain e.g. example.com, where environment resources reside, usually the same as MailFromDNSDomainName (future use)",
      "MaxLength": "25",
      "MinLength": "3",
      "Type": "String"
    },
    "SecurityGroupIdpwmInstance": {
      "Description": "ID of the security group for pwm instances",
      "Type": "AWS::EC2::SecurityGroup::Id"
    },
    "pwmSESIAMUserName": {
      "Description": "IAM Username used for SES email sending (must be unique per deployment)",
      "Type": "String"
    },
    "SNSSubscriptionEmail": {
      "AllowedPattern": "^([a-zA-Z0-9_\\-\\.]+)@([a-zA-Z0-9_\\-\\.]+)\\.([a-zA-Z]{2,5})$",
      "Default": "deployer@example.com",
      "Description": "Email address to which AWS SNS events and SES IAM Account rotate confirmations are sent.",
      "MinLength": "3",
      "Type": "String"
    },
    "pwmScapOutputBucketName": {
      "Description": "Name of the S3 bucket where the scap scan output will be copied",
      "Type": "String"
    }
  },
  "Resources": {
    "AllowAdminIAMGroupSSHKeyAccess": {
      "Properties": {
        "PolicyName": "AllowAdminIAMGroupSSHKeyAccess",
        "PolicyDocument": {
          "Statement": [
            {
              "Action": [
                "iam:GetGroup"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:aws:iam::",
                      {
                        "Ref": "AWS::AccountId"
                      },
                      ":group/",
                      {
                        "Ref": "AdminIAMGroup"
                      }
                    ]
                  ]
                }
              ]
            },
            {
              "Action": [
                "iam:GetSSHPublicKey",
                "iam:ListSSHPublicKeys"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:aws:iam::",
                      {
                        "Ref": "AWS::AccountId"
                      },
                      ":user/*"
                    ]
                  ]
                }
              ]
            }
          ],
          "Version": "2012-10-17"
        },
        "Roles": [
          {
            "Ref": "pwmInstanceRole"
          }
        ]
      },
      "Type": "AWS::IAM::Policy"
    },
    "AllowDiscoIAMGroupSSHKeyAccess": {
      "Condition": "ConfigureDiscovery",
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": [
                "iam:GetGroup"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:aws:iam::",
                      {
                        "Ref": "AWS::AccountId"
                      },
                      ":group/",
                      {
                        "Ref": "DiscoIAMGroup"
                      }
                    ]
                  ]
                }
              ]
            },
            {
              "Action": [
                "iam:GetSSHPublicKey",
                "iam:ListSSHPublicKeys"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:aws:iam::",
                      {
                        "Ref": "AWS::AccountId"
                      },
                      ":user/*"
                    ]
                  ]
                }
              ]
            }
          ],
          "Version": "2012-10-17"
        },
        "PolicyName": "AllowDiscoIAMGroupSSHKeyAccess",
        "Roles": [
          {
            "Ref": "pwmInstanceRole"
          }
        ]
      },
      "Type": "AWS::IAM::Policy"
    },
    "pwmConfigInstanceS3Access": {
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": [
                "s3:GetObject",
                "s3:PutObject",
                "s3:PutObjectAcl"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:aws:s3:::",
                      {
                        "Ref": "pwmConfigBucketName"
                      },
                      "/*"
                    ]
                  ]
                }
              ]
            }
          ],
          "Version": "2012-10-17"
        },
        "PolicyName": "pwmConfigInstanceS3Access",
        "Roles": [
          {
            "Ref": "pwmInstanceRole"
          }
        ]
      },
      "Type": "AWS::IAM::Policy"
    },
    "pwmScapOutputS3Access": {
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": [
                "s3:PutObject"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:aws:s3:::",
                      {
                        "Ref": "pwmScapOutputBucketName"
                      },
                      "/*"
                    ]
                  ]
                }
              ]
            }
          ],
          "Version": "2012-10-17"
        },
        "PolicyName": "pwmScapOutputS3Access",
        "Roles": [
          {
            "Ref": "pwmInstanceRole"
          }
        ]
      },
      "Type": "AWS::IAM::Policy"
    },
    "pwmCloudWatchAgent": {
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": [
                "cloudwatch:PutMetricData",
                "ec2:DescribeTags",
                "logs:CreateLogGroup",
                "logs:CreateLogStream",
                "logs:DescribeLogStreams",
                "logs:PutLogEvents",
                "ssm:GetParameter"
              ],
              "Effect": "Allow",
              "Resource": [
                "*"
              ]
            }
          ],
          "Version": "2012-10-17"
        },
        "PolicyName": "pwmCloudWatchAgent",
        "Roles": [
          {
            "Ref": "pwmInstanceRole"
          }
        ]
      },
      "Type": "AWS::IAM::Policy"
    },
    "pwmSSMManagedInstanceCore": {
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Effect": "Allow",
              "Action": [
                "ssm:DescribeAssociation",
                "ssm:GetDeployablePatchSnapshotForInstance",
                "ssm:GetDocument",
                "ssm:DescribeDocument",
                "ssm:GetManifest",
                "ssm:GetParameter",
                "ssm:GetParameters",
                "ssm:ListAssociations",
                "ssm:ListInstanceAssociations",
                "ssm:PutInventory",
                "ssm:PutComplianceItems",
                "ssm:PutConfigurePackageResult",
                "ssm:UpdateAssociationStatus",
                "ssm:UpdateInstanceAssociationStatus",
                "ssm:UpdateInstanceInformation"
              ],
              "Resource": "*"
            },
            {
              "Effect": "Allow",
              "Action": [
                "ssmmessages:CreateControlChannel",
                "ssmmessages:CreateDataChannel",
                "ssmmessages:OpenControlChannel",
                "ssmmessages:OpenDataChannel"
              ],
              "Resource": "*"
            },
            {
              "Effect": "Allow",
              "Action": [
                "ec2messages:AcknowledgeMessage",
                "ec2messages:DeleteMessage",
                "ec2messages:FailMessage",
                "ec2messages:GetEndpoint",
                "ec2messages:GetMessages",
                "ec2messages:SendReply"
              ],
              "Resource": "*"
            }
          ],
          "Version": "2012-10-17"
        },
        "PolicyName": "pwmSSMManagedInstanceCore",
        "Roles": [
          {
            "Ref": "pwmInstanceRole"
          }
        ]
      },
      "Type": "AWS::IAM::Policy"
    },
    "pwmManageSESIAMAccessKey": {
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": [
                "iam:CreateAccessKey",
                "iam:UpdateAccessKey",
                "iam:DeleteAccessKey",
                "iam:ListAccessKeys"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:aws:iam::",
                      {
                        "Ref": "AWS::AccountId"
                      },
                      ":user/",
                      {
                        "Ref": "pwmSESIAMUserName"
                      }
                    ]
                  ]
                }
              ]
            }
          ],
          "Version": "2012-10-17"
        },
        "PolicyName": "pwmManageSESIAMAccessKey",
        "Roles": [
          {
            "Ref": "pwmInstanceRole"
          }
        ]
      },
      "Type": "AWS::IAM::Policy"
    },
    "pwmAutoScalingGroup": {
      "CreationPolicy": {
        "ResourceSignal": {
          "Count": {
            "Ref": "DesiredCapacity"
          },
          "Timeout": "PT40M"
        }
      },
      "Properties": {
        "DesiredCapacity": {
          "Ref": "DesiredCapacity"
        },
        "HealthCheckGracePeriod": "3600",
        "HealthCheckType": "ELB",
        "LaunchConfigurationName": {
          "Ref": "pwmLaunchConfig"
        },
        "MaxSize": {
          "Ref": "MaxCapacity"
        },
        "MinSize": {
          "Ref": "MinCapacity"
        },
        "NotificationConfigurations": [
          {
            "NotificationTypes": [
              "autoscaling:EC2_INSTANCE_LAUNCH",
              "autoscaling:EC2_INSTANCE_LAUNCH_ERROR",
              "autoscaling:EC2_INSTANCE_TERMINATE",
              "autoscaling:EC2_INSTANCE_TERMINATE_ERROR"
            ],
            "TopicARN": {
              "Ref": "pwmSNSTopicARN"
            }
          }
        ],
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Ref": "AWS::StackName"
            },
            "PropagateAtLaunch": "true"
          }
        ],
        "TargetGroupARNs": [
          {
            "Ref": "pwmALBTargetGroupName"
          }
        ],
        "VPCZoneIdentifier": {
          "Ref": "PrivateSubnetIDs"
        }
      },
      "Type": "AWS::AutoScaling::AutoScalingGroup",
      "UpdatePolicy": {
        "AutoScalingReplacingUpdate": {
          "WillReplace": "true"
        }
      }
    },
    "pwmInstanceProfile": {
      "Properties": {
        "Path": "/",
        "Roles": [
          {
            "Ref": "pwmInstanceRole"
          }
        ]
      },
      "Type": "AWS::IAM::InstanceProfile"
    },
    "pwmInstanceRole": {
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": [
                "sts:AssumeRole"
              ],
              "Effect": "Allow",
              "Principal": {
                "Service": [
                  "ec2.amazonaws.com"
                ]
              }
            }
          ],
          "Version": "2012-10-17"
        },
        "Path": "/"
      },
      "Type": "AWS::IAM::Role"
    },
    "pwmLaunchConfig": {
      "Metadata": {
        "AWS::CloudFormation::Init": {
          "configSets": {
            "Install": [
              "a-cfnsetup",
              "b-wamandpwm",
              "c-adminusersetup",
              {
                "Fn::If": [
                  "ConfigureDiscovery",
                  "d-discousersetup",
                  {
                    "Ref": "AWS::NoValue"
                  }
                ]
              },
              "e-cloudwatchagentsetup",
              "f-inspectoragentsetup",
              "h-finalize"
            ]
          },
          "a-cfnsetup": {
            "files": {
              "/etc/cfn/cfn-hup.conf": {
                "content": {
                  "Fn::Join": [
                    "",
                    [
                      "[main]\n",
                      "stack=",
                      {
                        "Ref": "AWS::StackId"
                      },
                      "\n",
                      "region=",
                      {
                        "Ref": "AWS::Region"
                      },
                      "\n",
                      "interval=1",
                      "\n",
                      "verbose=true",
                      "\n"
                    ]
                  ]
                },
                "group": "root",
                "mode": "000400",
                "owner": "root"
              },
              "/etc/cfn/hooks.d/cfn-auto-reloader.conf": {
                "content": {
                  "Fn::Join": [
                    "",
                    [
                      "[cfn-auto-reloader-hook]\n",
                      "triggers=post.update\n",
                      "path=Resources.pwmLaunchConfig.Metadata.AWS::CloudFormation::Init\n",
                      "action=/opt/aws/bin/cfn-init -v -c update",
                      " --stack ",
                      {
                        "Ref": "AWS::StackName"
                      },
                      " --resource pwmLaunchConfig",
                      " --region ",
                      {
                        "Ref": "AWS::Region"
                      },
                      "\n",
                      "runas=root\n"
                    ]
                  ]
                },
                "group": "root",
                "mode": "000400",
                "owner": "root"
              }
            },
            "services": {
              "sysvinit": {
                "cfn-hup": {
                  "enabled": "true",
                  "ensureRunning": "true",
                  "files": [
                    "/etc/cfn/cfn-hup.conf",
                    "/etc/cfn/hooks.d/cfn-auto-reloader.conf"
                  ]
                }
              }
            }
          },
          "b-wamandpwm": {
            "commands": {
              "05-aws-symlink": {
                "command": {
                  "Fn::Join": [
                    "",
                    [
                      "ln -s /usr/local/aws-cli/v1/bin/aws /bin/aws",
                      "\n"
                    ]
                  ]
                }
              },
              "10-install-epel": {
                "command": {
                  "Fn::Join": [
                    "",
                    [
                      "yum -y install epel-release",
                      "\n"
                    ]
                  ]
                }
              },
              "11-enable-epel": {
                "command": {
                  "Fn::Join": [
                    "",
                    [
                      "yum-config-manager --enable epel",
                      "\n"
                    ]
                  ]
                }
              },
              "20-watchmaker-prep+launch": {
                "command": {
                  "Fn::Join": [
                    "",
                    [
                      "PYPI_URL=https://pypi.org/simple && export LC_ALL=en_US.UTF-8 && export LANG=en_US.UTF-8 && python3 -m ensurepip --upgrade --default-pip && pip install --index-url=\"$PYPI_URL\" --upgrade 'pip<20' setuptools && pip install --index-url=\"$PYPI_URL\" --upgrade watchmaker && watchmaker --log-level debug -n --log-dir=/var/log/watchmaker",
                      "\n"
                    ]
                  ]
                }
              },
              "30-put-scap-output": {
                "command": {
                  "Fn::Join": [
                    "",
                    [
                      "ec2id=$(wget -q -O - http://169.254.169.254/latest/meta-data/instance-id) && aws s3 cp /root/scap/output/ s3://",
                      {
                        "Ref": "pwmScapOutputBucketName"
                      },
                      "/pwm/$ec2id/ --recursive",
                      "\n"
                    ]
                  ]
                }
              },
              "40-clonepwmformula": {
                "command": {
                  "Fn::Join": [
                    "",
                    [
                      "git clone -b pwm1.8 https://github.com/ewierschke/pwm-formula /srv/salt/formulas/pwm-formula",
                      "\n"
                    ]
                  ]
                }
              },
              "41-adpassnotify_grain_setup": {
                "command": {
                  "Fn::Join": [
                    "",
                    [
                      "echo \"setupadpasswordexpirenotify: '",
                      {
                        "Ref": "ConfigureADPasswordExpireNotify"
                      },
                      "'\" >> /etc/salt/grains"
                    ]
                  ]
                }
              },
              "42-newuserviaemail_grain_setup": {
                "command": {
                  "Fn::Join": [
                    "",
                    [
                      "echo \"setupnewusernotifyviaemail: '",
                      {
                        "Ref": "ConfigureOstNewUserNotificationviaEmail"
                      },
                      "'\" >> /etc/salt/grains"
                    ]
                  ]
                }
              },
              "43-newuserviaapi_grain_setup": {
                "command": {
                  "Fn::Join": [
                    "",
                    [
                      "echo \"setupnewusernotifyviaapi: '",
                      {
                        "Ref": "ConfigureOstNewUserNotificationviaAPI"
                      },
                      "'\" >> /etc/salt/grains"
                    ]
                  ]
                }
              },
              "45-minion_prepa": {
                "command": {
                  "Fn::Join": [
                    "",
                    [
                      "cp /srv/salt/formulas/pwm-formula/pwm.conf /etc/salt/minion.d/",
                      "\n"
                    ]
                  ]
                }
              },
              "51-set_envirname_var": {
                "command": {
                  "Fn::Join": [
                    "",
                    [
                      "echo 'export ENVIRNAME=$(cat /usr/local/bin/envirname)' >> /root/.bashrc & export ENVIRNAME=$(cat /usr/local/bin/envirname)",
                      "\n"
                    ]
                  ]
                }
              },
              "52-set_resourcedomain_var": {
                "command": {
                  "Fn::Join": [
                    "",
                    [
                      "echo 'export RESOURCEDOMAIN=$(cat /usr/local/bin/resourcedomain)' >> /root/.bashrc & export RESOURCEDOMAIN=$(cat /usr/local/bin/resourcedomain)",
                      "\n"
                    ]
                  ]
                }
              },
              "53-set_configbucket_var": {
                "command": {
                  "Fn::Join": [
                    "",
                    [
                      "echo 'export CONFIGBUCKETNAME=$(cat /usr/local/bin/configbucketname)' >> /root/.bashrc & export CONFIGBUCKETNAME=$(cat /usr/local/bin/configbucketname)",
                      "\n"
                    ]
                  ]
                }
              },
              "80-firewalld": {
                "command": {
                  "Fn::Join": [
                    "",
                    [
                      "setenforce 0 && firewall-cmd --zone=public --add-service=http --permanent && firewall-cmd --zone=public --add-service=http && setenforce 1",
                      "\n"
                    ]
                  ]
                }
              },
              "90-applypwmstate": {
                "command": {
                  "Fn::Join": [
                    "",
                    [
                      "CONFIGBUCKETNAME=\"$(cat /usr/local/bin/configbucketname)\" RESOURCEDOMAIN=\"$(cat /usr/local/bin/resourcedomain)\" ENVIRNAME=\"$(cat /usr/local/bin/envirname)\" SNSSUBSCRIPTIONEMAIL=\"$(cat /usr/local/bin/snssubscriptionemail)\" MAILFROMDNSDOMAINNAME=\"$(cat /usr/local/bin/mailfromdomain)\" pwmSESIAMUSERNAME=\"$(cat /usr/local/bin/pwmsesiamusername)\" salt-call --local --retcode-passthrough state.apply pwm",
                      "\n"
                    ]
                  ]
                },
                "ignoreErrors": "false"
              },
              "91-yumupdate": {
                "command": {
                  "Fn::Join": [
                    "",
                    [
                      "yum -y update",
                      "\n"
                    ]
                  ]
                },
                "ignoreErrors": "false"
              }
            },
            "files": {
              "/usr/local/bin/adminemailto": {
                "content": {
                  "Ref": "AdminReportMailToEmailAddress"
                },
                "group": "root",
                "mode": "000600",
                "owner": "root"
              },
              "/usr/local/bin/configbucketname": {
                "content": {
                  "Ref": "pwmConfigBucketName"
                },
                "group": "root",
                "mode": "000600",
                "owner": "root"
              },
              "/usr/local/bin/emailfrom": {
                "content": {
                  "Ref": "MailFromEmailAddress"
                },
                "group": "root",
                "mode": "000600",
                "owner": "root"
              },
              "/usr/local/bin/emailfrompwm": {
                "content": {
                  "Ref": "MailFrompwmEmailAddress"
                },
                "group": "root",
                "mode": "000600",
                "owner": "root"
              },
              "/usr/local/bin/envirname": {
                "content": {
                  "Ref": "FriendlyEnvironmentName"
                },
                "group": "root",
                "mode": "000600",
                "owner": "root"
              },
              "/usr/local/bin/resourcedomain": {
                "content": {
                  "Ref": "ResourceDNSDomainName"
                },
                "group": "root",
                "mode": "000600",
                "owner": "root"
              },
              "/usr/local/bin/ldaphostname": {
                "content": {
                  "Ref": "ADHostname"
                },
                "group": "root",
                "mode": "000600",
                "owner": "root"
              },
              "/usr/local/bin/mailfromdomain": {
                "content": {
                  "Ref": "MailFromDNSDomainName"
                },
                "group": "root",
                "mode": "000600",
                "owner": "root"
              },
              "/usr/local/bin/mailtoaddress": {
                "content": {
                  "Ref": "NewUserMailToEmailAddress"
                },
                "group": "root",
                "mode": "000600",
                "owner": "root"
              },
              "/usr/local/bin/oupath": {
                "content": {
                  "Ref": "ADOUPath"
                },
                "group": "root",
                "mode": "000600",
                "owner": "root"
              },
              "/usr/local/bin/ostapikey": {
                "content": {
                  "Ref": "HelpdeskAPIKey"
                },
                "group": "root",
                "mode": "000600",
                "owner": "root"
              },
              "/usr/local/bin/ostemail": {
                "content": {
                  "Ref": "HelpdeskEmailAddress"
                },
                "group": "root",
                "mode": "000600",
                "owner": "root"
              },
              "/usr/local/bin/osturl": {
                "content": {
                  "Ref": "HelpdeskPublicURL"
                },
                "group": "root",
                "mode": "000600",
                "owner": "root"
              },
              "/usr/local/bin/pwmurl": {
                "content": {
                  "Ref": "pwmPublicURL"
                },
                "group": "root",
                "mode": "000600",
                "owner": "root"
              },
              "/usr/local/bin/svcacctpass": {
                "content": {
                  "Ref": "ADSvcAccountPassword"
                },
                "group": "root",
                "mode": "000600",
                "owner": "root"
              },
              "/usr/local/bin/svcacctupn": {
                "content": {
                  "Ref": "ADSvcAccountUPN"
                },
                "group": "root",
                "mode": "000600",
                "owner": "root"
              },
              "/usr/local/bin/snssubscriptionemail": {
                "content": {
                  "Ref": "SNSSubscriptionEmail"
                },
                "group": "root",
                "mode": "000600",
                "owner": "root"
              },
              "/usr/local/bin/pwmsesiamusername": {
                "content": {
                  "Ref": "pwmSESIAMUserName"
                },
                "group": "root",
                "mode": "000600",
                "owner": "root"
              }
            },
            "packages": {
              "yum": {
                "git": []
              }
            }
          },
          "c-adminusersetup": {
            "commands": {
              "10-cp_adminsshusermgmt": {
                "command": {
                  "Fn::Join": [
                    "",
                    [
                      "cp /srv/salt/formulas/pwm-formula/pwm/adminusermgmt.sh /usr/local/bin/adminusermgmt.sh",
                      "\n"
                    ]
                  ]
                }
              },
              "20-ch_adminsshusermgmt": {
                "command": {
                  "Fn::Join": [
                    "",
                    [
                      "chmod 700 /usr/local/bin/adminusermgmt.sh & chown root /usr/local/bin/adminusermgmt.sh & chgrp root /usr/local/bin/adminusermgmt.sh",
                      "\n"
                    ]
                  ]
                }
              },
              "30-configure_sshd_command": {
                "command": {
                  "Fn::Join": [
                    "",
                    [
                      "sed -i 's:#AuthorizedKeysCommand none:AuthorizedKeysCommand /usr/local/bin/authorized_keys_command.sh:g' /etc/ssh/sshd_config",
                      "\n"
                    ]
                  ]
                }
              },
              "40-configure_sshd_commanduser": {
                "command": {
                  "Fn::Join": [
                    "",
                    [
                      "sed -i 's:#AuthorizedKeysCommandUser nobody:AuthorizedKeysCommandUser nobody:g' /etc/ssh/sshd_config",
                      "\n"
                    ]
                  ]
                }
              },
              "50-runadminsshusermgmt": {
                "command": {
                  "Fn::Join": [
                    "",
                    [
                      "/usr/local/bin/adminusermgmt.sh -G $(cat /usr/local/bin/admingroupname)",
                      "\n"
                    ]
                  ]
                }
              }
            },
            "files": {
              "/etc/cron.d/adminusermgmt": {
                "content": {
                  "Fn::Join": [
                    "",
                    [
                      "*/8 * * * * root /usr/local/bin/adminusermgmt.sh -G $(cat /usr/local/bin/admingroupname)",
                      "\n"
                    ]
                  ]
                },
                "group": "root",
                "mode": "000644",
                "owner": "root"
              },
              "/usr/local/bin/admingroupname": {
                "content": {
                  "Ref": "AdminIAMGroup"
                },
                "group": "root",
                "mode": "000600",
                "owner": "root"
              },
              "/usr/local/bin/authorized_keys_command.sh": {
                "content": {
                  "Fn::Join": [
                    "",
                    [
                      "#!/bin/bash -e",
                      "\n",
                      "if [ -z \"$1\" ]; then",
                      "\n",
                      "  exit 1",
                      "\n",
                      "fi",
                      "\n",
                      "aws iam list-ssh-public-keys --user-name \"$1\" --query \"SSHPublicKeys[?Status == 'Active'].[SSHPublicKeyId]\" --output text | while read KeyId; do",
                      "\n",
                      "  aws iam get-ssh-public-key --user-name \"$1\" --ssh-public-key-id \"$KeyId\" --encoding SSH --query \"SSHPublicKey.SSHPublicKeyBody\" --output text",
                      "\n",
                      "done",
                      "\n"
                    ]
                  ]
                },
                "group": "root",
                "mode": "000755",
                "owner": "root"
              }
            }
          },
          "d-discousersetup": {
            "commands": {
              "10-cp_discosshusermgmt": {
                "command": {
                  "Fn::Join": [
                    "",
                    [
                      "cp /srv/salt/formulas/pwm-formula/pwm/discousermgmt.sh /usr/local/bin/discousermgmt.sh",
                      "\n"
                    ]
                  ]
                }
              },
              "20-ch_discosshusermgmt": {
                "command": {
                  "Fn::Join": [
                    "",
                    [
                      "chmod 700 /usr/local/bin/discousermgmt.sh & chown root /usr/local/bin/discousermgmt.sh & chgrp root /usr/local/bin/discousermgmt.sh",
                      "\n"
                    ]
                  ]
                }
              },
              "30-rundiscosshusermgmt": {
                "command": {
                  "Fn::Join": [
                    "",
                    [
                      "/usr/local/bin/discousermgmt.sh -G $(cat /usr/local/bin/discogroupname)",
                      "\n"
                    ]
                  ]
                }
              }
            },
            "files": {
              "/etc/cron.d/discousermgmt": {
                "content": {
                  "Fn::Join": [
                    "",
                    [
                      "*/8 * * * * root /usr/local/bin/discousermgmt.sh -G $(cat /usr/local/bin/discogroupname)",
                      "\n"
                    ]
                  ]
                },
                "group": "root",
                "mode": "000644",
                "owner": "root"
              },
              "/usr/local/bin/discogroupname": {
                "content": {
                  "Ref": "DiscoIAMGroup"
                },
                "group": "root",
                "mode": "000600",
                "owner": "root"
              }
            }
          },
          "e-cloudwatchagentsetup": {
            "commands": {
              "10-get-agent": {
                "command": {
                  "Fn::Join": [
                    "",
                    [
                      "wget https://s3.amazonaws.com/amazoncloudwatch-agent/linux/amd64/latest/AmazonCloudWatchAgent.zip",
                      "\n"
                    ]
                  ]
                }
              },
              "20-unpack-agent": {
                "command": {
                  "Fn::Join": [
                    "",
                    [
                      "unzip AmazonCloudWatchAgent.zip -d /usr/local/bin",
                      "\n"
                    ]
                  ]
                }
              },
              "30-install-agent": {
                "command": {
                  "Fn::Join": [
                    "",
                    [
                      "cd /usr/local/bin && bash -xe /usr/local/bin/install.sh",
                      "\n"
                    ]
                  ]
                }
              },
              "40-enable-agent": {
                "command": {
                  "Fn::Join": [
                    "",
                    [
                      "systemctl enable amazon-cloudwatch-agent.service",
                      "\n"
                    ]
                  ]
                }
              },
              "50-start-agent": {
                "command": {
                  "Fn::Join": [
                    "",
                    [
                      "systemctl start amazon-cloudwatch-agent.service",
                      "\n"
                    ]
                  ]
                }
              },
              "60-get-conf": {
                "command": {
                  "Fn::Join": [
                    "",
                    [
                      "aws s3 cp s3://",
                      {
                        "Ref": "pwmConfigBucketName"
                      },
                      "/18branch/pwmcloudwatchagent.json /opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json"
                    ]
                  ]
                }
              },
              "61-chmod-conf": {
                "command": {
                  "Fn::Join": [
                    "",
                    [
                      "chmod 640 /opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json",
                      "\n"
                    ]
                  ]
                }
              },
              "62-chown-conf": {
                "command": {
                  "Fn::Join": [
                    "",
                    [
                      "chown root:root /opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json",
                      "\n"
                    ]
                  ]
                }
              },
              "70-inject-custom-agent-config": {
                "command": {
                  "Fn::Join": [
                    "",
                    [
                      "/opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl -a fetch-config -m ec2 -c file:/opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json -s"
                    ]
                  ]
                }
              }
            },
            "packages": {
              "yum": {
                "unzip": []
              }
            }
          },
          "f-inspectoragentsetup": {
            "commands": {
              "10-get-agent": {
                "command": {
                  "Fn::Join": [
                    "",
                    [
                      "wget -O inspectorinstall https://inspector-agent.amazonaws.com/linux/latest/install",
                      "\n"
                    ]
                  ]
                }
              },
              "20-disable-gpgcheck": {
                "command": {
                  "Fn::Join": [
                    "",
                    [
                      "sed -i 's:gpgcheck=1:gpgcheck=0:g' /etc/yum.conf",
                      "\n"
                    ]
                  ]
                }
              },
              "21-disable-localpkg_gpgcheck": {
                "command": {
                  "Fn::Join": [
                    "",
                    [
                      "sed -i 's:localpkg_gpgcheck = 1:localpkg_gpgcheck = 0:g' /etc/yum.conf",
                      "\n"
                    ]
                  ]
                }
              },
              "30-run-install-script": {
                "command": {
                  "Fn::Join": [
                    "",
                    [
                      "bash inspectorinstall",
                      "\n"
                    ]
                  ]
                }
              },
              "40-enable-gpgcheck": {
                "command": {
                  "Fn::Join": [
                    "",
                    [
                      "sed -i 's:gpgcheck=0:gpgcheck=1:g' /etc/yum.conf",
                      "\n"
                    ]
                  ]
                }
              },
              "41-enable-localpkg_gpgcheck": {
                "command": {
                  "Fn::Join": [
                    "",
                    [
                      "sed -i 's:localpkg_gpgcheck = 0:localpkg_gpgcheck = 1:g' /etc/yum.conf",
                      "\n"
                    ]
                  ]
                }
              }
            }
          },
          "g-ssmagentsetup": {
            "commands": {
              "10-disable-gpgcheck": {
                "command": {
                  "Fn::Join": [
                    "",
                    [
                      "sed -i 's:gpgcheck=1:gpgcheck=0:g' /etc/yum.conf",
                      "\n"
                    ]
                  ]
                }
              },
              "11-disable-localpkg_gpgcheck": {
                "command": {
                  "Fn::Join": [
                    "",
                    [
                      "sed -i 's:localpkg_gpgcheck = 1:localpkg_gpgcheck = 0:g' /etc/yum.conf",
                      "\n"
                    ]
                  ]
                }
              },
              "20-run-install-script": {
                "command": {
                  "Fn::Join": [
                    "",
                    [
                      "yum install -y https://s3.amazonaws.com/ec2-downloads-windows/SSMAgent/latest/linux_amd64/amazon-ssm-agent.rpm",
                      "\n"
                    ]
                  ]
                }
              },
              "30-enable-gpgcheck": {
                "command": {
                  "Fn::Join": [
                    "",
                    [
                      "sed -i 's:gpgcheck=0:gpgcheck=1:g' /etc/yum.conf",
                      "\n"
                    ]
                  ]
                }
              },
              "31-enable-localpkg_gpgcheck": {
                "command": {
                  "Fn::Join": [
                    "",
                    [
                      "sed -i 's:localpkg_gpgcheck = 0:localpkg_gpgcheck = 1:g' /etc/yum.conf",
                      "\n"
                    ]
                  ]
                }
              }
            }
          },
          "h-finalize": {
            "commands": {
              "10-safety-yum-update": {
                "command": {
                  "Fn::Join": [
                    "",
                    [
                      "yum -y update",
                      "\n"
                    ]
                  ]
                }
              },
              "20-signal-success": {
                "command": {
                  "Fn::Join": [
                    "",
                    [
                      "cfn-signal -e 0 ",
                      "   --stack ",
                      {
                        "Ref": "AWS::StackName"
                      },
                      "   --resource pwmAutoScalingGroup",
                      "   --region ",
                      {
                        "Ref": "AWS::Region"
                      },
                      ";sleep 15;reboot now\n"
                    ]
                  ]
                },
                "ignoreErrors": "false"
              }
            }
          }
        }
      },
      "Properties": {
        "BlockDeviceMappings": [
          {
            "DeviceName": "/dev/sda1",
            "Ebs": {
              "VolumeSize": "30",
              "VolumeType": "gp2",
              "DeleteOnTermination": "true"
            }
          }
        ],
        "IamInstanceProfile": {
          "Ref": "pwmInstanceProfile"
        },
        "ImageId": {
          "Ref": "AmiId"
        },
        "InstanceType": {
          "Ref": "InstanceType"
        },
        "KeyName": {
          "Ref": "KeyPairName"
        },
        "SecurityGroups": [
          {
            "Ref": "SecurityGroupIdpwmInstance"
          }
        ],
        "UserData": {
          "Fn::Base64": {
            "Fn::Join": [
              "",
              [
                "Content-Type: multipart/mixed; boundary=\"===============3585321300151562773==\"\n",
                "MIME-Version: 1.0\n",
                "\n",
                "--===============3585321300151562773==\n",
                "Content-Type: text/cloud-config; charset=\"us-ascii\"\n",
                "MIME-Version: 1.0\n",
                "Content-Transfer-Encoding: 7bit\n",
                "Content-Disposition: attachment; filename=\"cloud.cfg\"\n",
                "\n",
                "#cloud-config\n",
                "\n",
                "growpart:\n",
                "  mode: auto\n",
                "  devices: [ '/dev/xvda', '/dev/xvda2', '/dev/nvme0n1p2' ]\n",
                "  ignore_growroot_disabled: false\n",
                "\n",
                "--===============3585321300151562773==\n",
                "Content-Type: text/x-shellscript; charset=\"us-ascii\"\n",
                "MIME-Version: 1.0\n",
                "Content-Transfer-Encoding: 7bit\n",
                "Content-Disposition: attachment; filename=\"user-data.txt\"\n",
                "\n",
                "#!/bin/bash -xe\n\n",
                "# Expand root volume (100), based on any additional capacity available\n",
                "# If no addtional space allocated (> 20), command run w/o expanding\n",
                "# lvextend command return code is ignored/masked below -- basically brute force\n",
                "if [[ -x $( which pvs ) ]]\n",
                "then\n",
                "   LVMPVS=( $( pvs --noheadings -o pv_name ) )\n",
                "   for PV in \"${LVMPVS[@]}\"\n",
                "   do\n",
                "      pvresize \"${PV}\"\n",
                "   done\n",
                "fi\n",
                "# Brute force expansion of root\n",
                "lvextend -r -l +100%FREE /dev/VolGroup00/rootVol || true\n",
                "\n",
                "# Export cert bundle ENVs\n",
                "export AWS_CA_BUNDLE=/etc/pki/tls/certs/ca-bundle.crt\n",
                "export REQUESTS_CA_BUNDLE=/etc/pki/tls/certs/ca-bundle.crt\n\n",
                "# Get pip\n",
                "yum -y install python3-pip\n\n",
                "# Upgrade pip and setuptools\n",
                "pip3 install",
                " --upgrade 'pip<20' setuptools\n\n",
                "if [[ $(rpm --quiet -q aws-cfn-bootstrap || pip3 show --quiet aws-cfn-bootstrap)$? -ne 0 ]]\n",
                "then\n",
                "  # Get cfn utils\n",
                "  pip3 install",
                " --upgrade --upgrade-strategy only-if-needed https://s3.amazonaws.com/cloudformation-examples/aws-cfn-bootstrap-latest.tar.gz\n\n",
                "  # Fixup cfn utils\n",
                "  INITDIR=$(find -L /opt/aws/apitools/cfn-init/init -name redhat",
                " 2> /dev/null || echo /usr/init/redhat)\n",
                "  chmod 775 ${INITDIR}/cfn-hup\n",
                "  ln -f -s ${INITDIR}/cfn-hup /etc/rc.d/init.d/cfn-hup\n",
                "  chkconfig --add cfn-hup\n",
                "  chkconfig cfn-hup on\n",
                "  mkdir -p /opt/aws/bin\n",
                "  BINDIR=$(find -L /opt/aws/apitools/cfn-init -name bin",
                " 2> /dev/null || echo /usr/bin)\n",
                "  for SCRIPT in cfn-elect-cmd-leader cfn-get-metadata cfn-hup",
                " cfn-init cfn-send-cmd-event cfn-send-cmd-result cfn-signal\n",
                "  do\n",
                "    ln -s ${BINDIR}/${SCRIPT} /opt/aws/bin/${SCRIPT} 2> /dev/null || ",
                "    echo Skipped symbolic link, /opt/aws/bin/${SCRIPT} already exists\n",
                "  done\n\n",
                "fi\n\n",
                "# Remove gcc now that it is no longer needed\n",
                "yum -y remove gcc --setopt=clean_requirements_on_remove=1\n\n",
                "# Add cfn-signal to path\n",
                "hash cfn-signal 2> /dev/null || ",
                "PATH=\"${PATH}:/usr/local/bin:/opt/aws/bin\"",
                "\n\n",
                "# Execute cfn-init\n",
                "/opt/aws/bin/cfn-init -v -c Install",
                " --stack ",
                {
                  "Ref": "AWS::StackName"
                },
                " --resource pwmLaunchConfig",
                " --region ",
                {
                  "Ref": "AWS::Region"
                },
                " ||",
                " ( echo 'ERROR: cfn-init failed! Aborting!';",
                " /opt/aws/bin/cfn-signal -e 1",
                "  --stack ",
                {
                  "Ref": "AWS::StackName"
                },
                "  --resource pwmAutoScalingGroup",
                "  --region ",
                {
                  "Ref": "AWS::Region"
                },
                ";",
                " exit 1",
                " )\n\n",
                "--===============3585321300151562773==--"
              ]
            ]
          }
        }
      },
      "Type": "AWS::AutoScaling::LaunchConfiguration"
    }
  }
}
